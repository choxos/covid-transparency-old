---
title: "Transparency of COVID-19-related research - Analysis"
author: Ahmad Sofi-Mahmudi, Eero Raittio
date: "2022-02-11"
output: html_document
---

# Loading required packages

```{r}
pacman::p_load(tidyverse,
               lubridate, 
               here, 
               ggplot2,
               knitr)
```


```{r, setup, include=FALSE}
# knitr::opts_knit$set(root.dir = '~/Documents/GitHub/covid-transparency/data')
```



# Loading the datasets
First, set working directory to the folder that has all the datasets in it using setwd() function and then run the following code:
```{r}
opendata <- read.csv(here("data", "covid_transparency_opendata.csv"))
```


# Results
Number of all papers (open access and non open access), open-access papers and open-access percentage:
```{r}
kable(data.frame(hits_all = 175550, 
           hits_oa = nrow(opendata),
           oa_percentage = round((nrow(opendata)/175550)*100, 2)))
```

First, adding the real publication year and month to the datasets. The real publication year/month is the year/month the paper was first appear online stored in firstPublicationDate column.
```{r}
opendata <- opendata %>%
        mutate(year_firstpub = year(as.POSIXlt(firstPublicationDate,
                                               format = "%Y-%m-%d")),
               month_firstpub = month(as.POSIXlt(firstPublicationDate,
                                                 format = "%Y-%m-%d")))
```


Number of open access papers per year:
```{r}
kable(table(opendata$year_firstpub))
```

The number of journals in our dataset:
```{r}
length(table(opendata$journal))
```
Top 10 journals with the highest number of articles in our dataset, from high to low:
```{r}
kable(head(table(opendata$journal) 
           %>% as.data.frame() 
           %>% arrange(desc(Freq)), 10))
```

Also, same table, but with all the journals

```{r}
opendata %>% 
        mutate(journal = fct_lump_prop(journal, prop = 0.01) ) %>% 
        count(journal) %>% 
        arrange(desc(n)) %>% 
        knitr::kable()
```



The mean and the median of the number of citations to these references:
```{r}
kable(data.frame(Mean = round(mean(opendata$citedByCount),1),
           SD = round(sd(opendata$citedByCount), 2),
           Median = median(opendata$citedByCount),
           IQR = IQR(opendata$citedByCount)
           ))

```

Characteristics of the paper with the highest number of citations:
```{r}
kable(opendata[which.max(opendata$citedByCount),] %>% 
  select(citedByCount, pmid, pmcid, doi.x, title, authorString, journalTitle, pubYear))
```

The number and percentage of papers with a conflict of interest (CoI) disclosure:
```{r}
kable(data.frame(
  number = length(opendata$is_coi_pred[opendata$is_coi_pred == TRUE]),
           percentage = round(length(opendata$is_coi_pred[opendata$is_coi_pred == TRUE])/nrow(opendata)*100, 2)
           ))
```

Confidence interval for CoI:
```{r}
library(epiR)

kable(round(epi.prev(pos = length(opendata$is_coi_pred[opendata$is_coi_pred == TRUE]),
         tested = nrow(opendata),
         se = 0.992,
         sp = 0.995)$ap, 
      2))
```

Comparing CoI disclosure rate in two years:
```{r}
kable(round(prop.table(table(opendata$is_coi_pred, opendata$year_firstpub), 2)*100, 1))
```

Chi-square test:
```{r}
chisq.test(opendata$is_coi_pred, opendata$year_firstpub)
```

The number and percentage of papers with a funding statement:
```{r}
kable(data.frame(number = length(opendata$is_fund_pred[opendata$is_fund_pred == TRUE]),
           percentage = round(length(opendata$is_fund_pred[opendata$is_fund_pred == TRUE])/nrow(opendata)*100, 2)
           ))
```

Confidence interval for funding statement:
```{r}

kable(round(epi.prev(pos = length(opendata$is_fund_pred[opendata$is_fund_pred == TRUE]),
         tested = nrow(opendata),
         se = 0.997,
         sp = 0.981)$ap, 
      2))
```

Comparing funding statement rate in two years:
```{r}
kable(round(prop.table(table(opendata$is_fund_pred, opendata$year_firstpub), 2)*100, 1))
```

Chi-square test:
```{r}
chisq.test(opendata$is_fund_pred, opendata$year_firstpub)
```

The number and percentage of papers that were registered beforehand:
```{r}
kable(data.frame(number = length(opendata$is_register_pred[opendata$is_register_pred == TRUE]),
           percentage = round(length(opendata$is_register_pred[opendata$is_register_pred == TRUE])/nrow(opendata)*100, 2)
           ))
```

Confidence interval for registration:
```{r}

kable(round(epi.prev(pos = length(opendata$is_register_pred[opendata$is_register_pred == TRUE]),
         tested = nrow(opendata),
         se = 0.955,
         sp = 0.997)$ap, 
      2))
```

Comparing registration rate in two years:
```{r}
kable(round(prop.table(table(opendata$is_register_pred, opendata$year_firstpub), 2)*100, 1))
```

Chi-square test:
```{r}
chisq.test(opendata$is_register_pred, opendata$year_firstpub)
```


The number and percentage of papers that shared data:
```{r}
kable(data.frame(number = length(opendata$is_open_data[opendata$is_open_data == TRUE]),
           percentage = round(length(opendata$is_open_data[opendata$is_open_data == TRUE])/nrow(opendata)*100, 2)
           ))
```

Confidence interval for data sharing:
```{r}

kable(round(epi.prev(pos = length(opendata$is_open_data[opendata$is_open_data == TRUE]),
         tested = nrow(opendata),
         se = 0.758,
         sp = 0.986)$ap, 
      2))
```

Comparing data sharing rate in two years:
```{r}
kable(round(prop.table(table(opendata$is_open_data, opendata$year_firstpub), 2)*100, 1))
```

Chi-square test:
```{r}
chisq.test(opendata$is_open_data, opendata$year_firstpub)
```

The number and percentage of papers that shared code:
```{r}
kable(data.frame(number = length(opendata$is_open_code[opendata$is_open_code == TRUE]),
           percentage = round(length(opendata$is_open_code[opendata$is_open_code == TRUE])/nrow(opendata)*100, 2)
           ))
```

Confidence interval for sharing code:
```{r}

kable(round(epi.prev(pos = length(opendata$is_open_code[opendata$is_open_code == TRUE]),
         tested = nrow(opendata),
         se = 0.587,
         sp = 0.997)$ap, 
      2))
```

Comparing sharing code rate in two years:
```{r}
kable(round(prop.table(table(opendata$is_open_code, opendata$year_firstpub), 2)*100, 1))
```

Chi-square test:
```{r}
chisq.test(opendata$is_open_code, opendata$year_firstpub)
```

## Journal Impact Factor (JIF) analyses

First, importing jif file:
```{r}
jif <- read.csv(here("data", "jif_2020.csv"))
```

Merging it with opendata:
```{r}
db_jif <- merge(opendata, jif, by.x = "journalIssn", by.y = "ISSN")
db_jif$X2020.JIF <- as.numeric(db_jif$X2020.JIF)
```

Total number of papers published in journals with no JIF:
```{r}
nrow(opendata) - nrow(db_jif)
```

JIF based on COI disclosure:
```{r}
kable(db_jif %>% 
  group_by(is_coi_pred) %>% 
  summarise(Mean = round(mean(X2020.JIF, na.rm = T),3),
            SD = round(sd(X2020.JIF, na.rm = T),4),
            Median = median(X2020.JIF, na.rm = T),
            IQR = IQR(X2020.JIF, na.rm = T)))
```

Test for normality:
```{r}
set.seed(10)

with(db_jif, shapiro.test(sample(X2020.JIF[is_coi_pred == TRUE], 5000)))
with(db_jif, shapiro.test(X2020.JIF[is_coi_pred == FALSE]))
```

Data is not normal, hence we will use unpaired two-samples Wilcoxon test.
```{r}
wilcox.test(X2020.JIF~is_coi_pred, data = db_jif, exact = FALSE)
```

JIF based on funding disclosure:
```{r}
kable(db_jif %>% 
  group_by(is_fund_pred) %>% 
  summarise(Mean = round(mean(X2020.JIF, na.rm = T), 3),
            SD = round(sd(X2020.JIF, na.rm = T), 4),
            Median = median(X2020.JIF, na.rm = T),
            IQR = IQR(X2020.JIF, na.rm = T)))
```

Test for normality:
```{r}
set.seed(10)

with(db_jif, shapiro.test(sample(X2020.JIF[is_fund_pred == TRUE], 5000)))
with(db_jif, shapiro.test(X2020.JIF[is_fund_pred == FALSE]))
```

Data is not normal, hence we will use unpaired two-samples Wilcoxon test.
```{r}
wilcox.test(X2020.JIF~is_fund_pred, data = db_jif, exact = FALSE)
```

JIF based on registration:
```{r}
kable(db_jif %>% 
  group_by(is_register_pred) %>% 
  summarise(Mean = round(mean(X2020.JIF, na.rm = T), 3),
            SD = round(sd(X2020.JIF, na.rm = T), 4),
            Median = median(X2020.JIF, na.rm = T),
            IQR = IQR(X2020.JIF, na.rm = T)))
```

Test for normality:
```{r}
set.seed(10)

with(db_jif, shapiro.test(X2020.JIF[is_register_pred == TRUE]))
with(db_jif, shapiro.test(sample(X2020.JIF[is_register_pred == FALSE], 5000)))
```

Data is not normal, hence we will use unpaired two-samples Wilcoxon test.
```{r}
wilcox.test(X2020.JIF~is_register_pred, data = db_jif, exact = FALSE)
```

JIF based on data sharing:
```{r}
kable(db_jif %>% 
  group_by(is_open_data) %>% 
  summarise(Mean = round(mean(X2020.JIF, na.rm = T), 3),
            SD = round(sd(X2020.JIF, na.rm = T), 4),
            Median = median(X2020.JIF, na.rm = T),
            IQR = IQR(X2020.JIF, na.rm = T)))
```

Test for normality:
```{r}
set.seed(10)

with(db_jif, shapiro.test(X2020.JIF[is_open_data == TRUE]))
with(db_jif, shapiro.test(sample(X2020.JIF[is_open_data == FALSE], 5000)))
```

Data is not normal, hence we will use unpaired two-samples Wilcoxon test.
```{r}
wilcox.test(X2020.JIF~is_open_data, data = db_jif, exact = FALSE)
```

JIF based on code sharing:
```{r}
kable(db_jif %>% 
  group_by(is_open_code) %>% 
  summarise(Mean = round(mean(X2020.JIF, na.rm = T), 3),
            SD = round(sd(X2020.JIF, na.rm = T), 4),
            Median = median(X2020.JIF, na.rm = T),
            IQR = IQR(X2020.JIF, na.rm = T)))
```

Test for normality:
```{r}
set.seed(10)

with(db_jif, shapiro.test(X2020.JIF[is_open_code == TRUE]))
with(db_jif, shapiro.test(sample(X2020.JIF[is_open_code == FALSE], 5000)))
```

Data is not normal, hence we will use unpaired two-samples Wilcoxon test.
```{r}
wilcox.test(X2020.JIF~is_open_code, data = db_jif, exact = FALSE)
```


## Monthly trend
Now, drawing monthly trend for each year:
```{r}
summarybyMonth <- opendata %>%
  group_by(month_firstpub, year_firstpub) %>%
  summarise(counts = n(),
            coi_true = sum(is_coi_pred == TRUE),
            fund_true = sum(is_fund_pred == TRUE),
            reg_true = sum(is_register_pred == TRUE),
            data_true = sum(is_open_data == TRUE),
            code_true = sum(is_open_code == TRUE))

coi_summarybyMonth <- opendata %>%
  group_by(month_firstpub, year_firstpub, is_coi_pred) %>%
  summarise(counts = n())

coi_plot <- coi_summarybyMonth %>%
  ggplot(aes(x = month_firstpub, y = counts, fill = is_coi_pred)) + 
  geom_col(position = position_dodge()) +
  facet_grid(. ~ year_firstpub) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name="Month", limits = 1:12, labels = 1:12) +
  theme_minimal() +
  theme(legend.title = element_blank(), 
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "Conflict of Interest disclosure",
       y = "Number of articles") +
        scale_fill_discrete(labels = c("Without", "With"),
                            guide = guide_legend(reverse=TRUE))

fund_summarybyMonth <- opendata %>%
  group_by(month_firstpub, year_firstpub, is_fund_pred) %>%
  summarise(counts = n())

fund_plot <- fund_summarybyMonth %>%
  ggplot(aes(x = month_firstpub, y = counts, fill = is_fund_pred)) + 
  geom_col(position = position_dodge()) +
  facet_grid(. ~ year_firstpub) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name="Month", limits = 1:12, labels = 1:12) +
  theme_minimal() +
  theme(legend.title = element_blank(), 
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "Funding statement",
       y = "Number of articles") +
        scale_fill_discrete(labels = c("Without", "With"),
                            guide = guide_legend(reverse=TRUE))

reg_summarybyMonth <- opendata %>%
  group_by(month_firstpub, year_firstpub, is_register_pred) %>%
  summarise(counts = n())

reg_plot <- reg_summarybyMonth %>%
  ggplot(aes(x = month_firstpub, y = counts, fill = is_register_pred)) + 
  geom_col(position = position_dodge()) +
  facet_grid(. ~ year_firstpub) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name="Month", limits = 1:12, labels = 1:12) +
  theme_minimal() +
  theme(legend.title = element_blank(), 
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "Registration statement",
       y = "Number of articles") +
        scale_fill_discrete(labels = c("Without", "With"),
                            guide = guide_legend(reverse=TRUE))

data_summarybyMonth <- opendata %>%
  group_by(month_firstpub, year_firstpub, is_open_data) %>%
  summarise(counts = n())

data_plot <- data_summarybyMonth %>%
  ggplot(aes(x = month_firstpub, y = counts, fill = is_open_data)) + 
  geom_col(position = position_dodge()) +
  facet_grid(. ~ year_firstpub) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name="Month", limits = 1:12, labels = 1:12) +
  theme_minimal() +
  theme(legend.title = element_blank(), 
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "Data sharing",
       y = "Number of articles") +
        scale_fill_discrete(labels = c("Without", "With"),
                            guide = guide_legend(reverse=TRUE))

code_summarybyMonth <- opendata %>%
  group_by(month_firstpub, year_firstpub, is_open_code) %>%
  summarise(counts = n())

code_plot <- code_summarybyMonth %>%
  ggplot(aes(x = month_firstpub, y = counts, fill = is_open_code)) + 
  geom_col(position = position_dodge()) +
  facet_grid(. ~ year_firstpub) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name="Month", limits = 1:12, labels = 1:12) +
  theme_minimal() +
  theme(legend.title = element_blank(), 
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "Code sharing",
       y = "Number of articles") +
        scale_fill_discrete(labels = c("Without", "With"),
                            guide = guide_legend(reverse=TRUE))

library(ggpubr)

figure <- ggarrange(coi_plot + rremove("xlab") + theme(axis.text.x=element_blank()), 
                    fund_plot + rremove("xlab") + theme(axis.text.x=element_blank(), strip.text.x = element_blank()),
                    reg_plot + theme(strip.text.x = element_blank()),
                    ncol = 1, nrow = 3, vjust = 1, 
                    align = "hv", common.legend = T, legend = "right")

figure <- ggarrange(coi_plot + rremove("xlab") + theme(axis.text.x=element_blank()), 
                    fund_plot + rremove("xlab") + theme(axis.text.x=element_blank(), strip.text.x = element_blank()),
                    reg_plot + rremove("xlab") + theme(axis.text.x=element_blank(), strip.text.x = element_blank()),
                    data_plot + rremove("xlab") + theme(axis.text.x=element_blank(), strip.text.x = element_blank()),
                    code_plot + theme(strip.text.x = element_blank()),
                    ncol = 1, nrow = 5, vjust = 1, 
                    align = "hv", common.legend = T, legend = "right")

# tiff("Figure.tiff", width = 6, height = 11, units = "in", res = 300)
figure
#dev.off()
```


